using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Networking;
using TMPro;
using System;
using System.Linq;
using UnityEngine.SceneManagement;

[System.Serializable]
public class GoogleData
{
    public string order, result, msg, _id,_name,_score,_height,_maxheight,_json;
}

public class GoogleSheetManager : MonoBehaviour
{


    [SerializeField]
    TMP_Text text_reponse;

    [SerializeField]
    TMP_Text text_Debug;

    const string URL = "https://script.google.com/macros/s/AKfycbz1w85NkFyqWb9fUWHLLevrZBAT1lgRG8exwvwrpShXMfwtILMznRcwMhicrtAz3fnL/exec";
    public string sheetData = "";
    public GoogleData GD;


    public static GoogleSheetManager Inst { get; private set; }

    private void Awake()
    {
        // 싱글톤 초기화
        if (Inst != null && Inst != this)
        {
            Destroy(gameObject);
            return;
        }
        Inst = this;
        DontDestroyOnLoad(gameObject);
    }

    private void Start()
    {
        //UpdateGameDataBySheet();
    }

    public void UpdateGameDataBySheet()
    {
        StartCoroutine(StartUpdate());
    }

    private IEnumerator StartUpdate()
    {
        UnityWebRequest www = UnityWebRequest.Get(URL);
        yield return www.SendWebRequest();


        string data = www.downloadHandler.text;
        print(data);

        //--- 이전 ----
        ////데이터 가져오기
        //string data = www.downloadHandler.text;

        //text.text = GetDataById(data, DiscordManager.Inst.userId);

        ////랭킹 업데이트
        //UIManager.Inst.UpdateRanking(GetTopMaxHeightPlayers(data, 5));


        //print(data);
    }

    public static string GetDataById(string inputData, string targetId)
    {
        // 데이터를 줄 단위로 나눔
        string[] lines = inputData.Split(new[] { '\n' }, StringSplitOptions.RemoveEmptyEntries);

        // 첫 번째 줄은 헤더이므로 건너뜀
        for (int i = 1; i < lines.Length; i++)
        {
            // 각 줄의 데이터를 탭으로 나눔
            string[] columns = lines[i].Split(new[] { '\t' }, StringSplitOptions.None);

            if (columns.Length < 6) continue; // 데이터 형식이 올바르지 않은 경우 건너뜀

            string id = columns[0];
            string name = columns[1];
            string score = columns[2];
            string height = columns[3];
            string maxHeight = columns[4];
            string json = columns[5];

            // id가 일치하면 해당 데이터를 반환
            if (id == targetId)
            {
                return $"Name: {name}, Score: {score}, Height: {height}, MaxHeight: {maxHeight}, JSON: {json}";
            }
        }

        // 데이터를 찾지 못한 경우
        return "Data not found";
    }

    //가장 높은 5명 리스트 반환코드
    public List<(string Name, float MaxHeight)> GetTopMaxHeightPlayers(string data, int topCount)
    {
        // 데이터를 줄 단위로 나눔
        string[] lines = data.Split(new[] { '\n' }, StringSplitOptions.RemoveEmptyEntries);

        // 첫 줄(헤더)은 무시하고 나머지 데이터 처리
        List<(string Name, float MaxHeight)> players = new List<(string Name, float MaxHeight)>();
        for (int i = 1; i < lines.Length; i++)
        {
            string[] columns = lines[i].Split('\t');
            if (columns.Length < 5) continue; // 유효하지 않은 데이터 건너뛰기

            string name = columns[1];
            if (float.TryParse(columns[4], out float maxHeight))
            {
                players.Add((name, maxHeight));
            }
        }

        // MaxHeight를 기준으로 내림차순 정렬 후 상위 topCount 추출
        return players.OrderByDescending(p => p.MaxHeight).Take(topCount).ToList();
    }

    [ContextMenu("register")]
    public void Register()
    {
        string id = DiscordManager.Inst.userId;
        string _name = DiscordManager.Inst.userName;

        WWWForm form = new WWWForm();
        form.AddField("order", "register");
        form.AddField("id", id);
        form.AddField("name", _name);
        form.AddField("score", 5);
        form.AddField("height", 0);
        form.AddField("maxheight", 0);
        form.AddField("json", "none");

        StartCoroutine(Post(form));
        
    }

    [ContextMenu("Login")]
    public void Login()
    {
        string id = DiscordManager.Inst.userId;

        WWWForm form = new WWWForm();
        form.AddField("order", "login");
        form.AddField("id", id);

        StartCoroutine(Post(form));
    }

    public void SetValue()
    {
        //WWWForm form = new WWWForm();
        //form.AddField("order", "getValue");

        //StartCoroutine(Post(form));
    }

    [ContextMenu("GetValue")]
    public void GetValue()
    {
        string id = DiscordManager.Inst.userId;
        WWWForm form = new WWWForm();
        form.AddField("order", "getValue");
        form.AddField("id", id);

        StartCoroutine(Post(form));
    }

    IEnumerator Post(WWWForm form)
    {
        using (UnityWebRequest www = UnityWebRequest.Post(URL, form))
        {
            yield return www.SendWebRequest();

            if (www.isDone) Response(www.downloadHandler.text);
            else print("웹 응답 없음");
        }
    }

    void Response(string json)
    {
        if (string.IsNullOrEmpty(json)) return;

        GD = JsonUtility.FromJson<GoogleData>(json);

        if(GD.result == "ERROR")
        {
            print(GD.order + " 을 실행할 수 없습니다. 에러 메세지 : " + GD.msg);
            text_reponse.text = GD.order + " 을 실행할 수 없습니다. 에러 메세지 : " + GD.msg;
            return;
        }

        if (GD.result == "OK")
        {
            print(GD.order + " 을 실행했습니다. 메세지 : " + GD.msg);
            text_reponse.text = GD.order + " 을 실행했습니다. 메세지 : " + GD.msg;
        }

        // 로그인 정보 없음 -> 회원가입
        if(GD.order == "login" && GD.result == "NOLOGINDATA")
        {
            print(GD.order + " 을 실행했습니다. 메세지 : 회원가입해야함 ");
            text_reponse.text = GD.order + " 을 실행했습니다. 메세지 : 회원가입해야함 ";
            Register();
            

            return;
        }

        if(GD.order == "login" && GD.result == "OK")
        {
            print(GD.order + " 을 실행했습니다. 메세지 : " + GD.msg);
            text_reponse.text = GD.order + " 을 실행했습니다. 메세지 : " + GD.msg;
            SceneManager.LoadScene("GameScene");
        }

        if(GD.order == "register")
        {
            Login();
        }

        if(GD.order == "getValue" && GD.result == "OK")
        {
            sheetData = GD._id + GD._name + GD._score+GD._height + GD._maxheight + GD._json;
            print("Sheet Data : " + sheetData);
            text_reponse.text = "Sheet Data : " + sheetData;

            //text_Debug.text = GD.value;
        }
    }


    private void OnApplicationQuit()
    {
        WWWForm form = new WWWForm();
        form.AddField("order", "logout");

        StartCoroutine (Post(form));
    }

}

